---

- name: create public_html directory
  file:
    path: "{{ data_mount_root }}/{{ www_directory }}"
    state: directory
    mode: 0755
    owner: "{{ media_user_uid }}"
    group: "{{ media_user_gid }}"
  notify:
    - restart nginx

- name: Install SSL Key
  copy:
    content: "{{ item.sslkeycontent }}"
    dest: "{{ item.sslkeyfile }}"
    owner: root
    group: ssl-cert
    mode: 0640
  with_items: "{{ nginx_vhosts_ssl }}"
  notify:
    - restart nginx

- name: Install SSL Certificate Chain
  copy:
    content: "{{ item.sslcertcontent }}"
    dest: "{{ item.sslcertfile }}"
    owner: root
    group: ssl-cert
    mode: 0640
  with_items: "{{ nginx_vhosts_ssl }}"
  notify:
    - restart nginx

- name: template nginx.conf
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify:
    - restart nginx

- name: template nginx default.conf
  template:
    src: default.conf.j2
    dest: "{{ nginx_cfg_dir }}/default.conf"
  notify:
    - restart nginx

- name: restart nginx
  service:
    name: nginx
    state: restarted
