# {{ ansible_managed }}

{% for vhost in nginx_vhosts %}
server {
    listen {{ vhost.serverlisten }};
{% if vhost.serveralias is defined %}
    server_name {{ vhost.servername }} {{ vhost.serveralias }};
{% else %}
    server_name {{ vhost.servername }};
{% endif %}

    access_log      /var/log/nginx/{{ vhost.servername }}_access.log main;
    error_log       /var/log/nginx/{{ vhost.servername }}_error.log warn;

    location / {

{% if vhost.docroot is defined %}
    root {{ vhost.docroot }};
{% endif %}

{% if vhost.extra_parameters is defined %}
    {{ vhost.extra_parameters }}
{% endif %}

{% if vhost.proxy is defined and vhost.proxy %}
    include /etc/nginx/proxy.conf;
    proxy_pass                http://{{ vhost.proxy_ip }}:{{ vhost.proxy_port }};
    proxy_redirect            http://{{ vhost.proxy_ip}}:{{ vhost.proxy_port }} http://$server_name;
{% if vhost.custom_css is defined %}
    proxy_set_header Accept-Encoding "";
    sub_filter
    '</head>'
    '<link rel="stylesheet" type="text/css" href="https://gilbn.github.io/theme.park/CSS/themes/{{ vhost.custom_css }}">
    </head>';
    sub_filter_once on;
{% endif %}
{% endif %}

    }
}
{% endfor %}