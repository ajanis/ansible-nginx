{% for vhost in nginx_vhosts %}
server {

    listen {{ vhost.serverlisten }};
{% if vhost.serveralias is defined %}
    server_name {{ vhost.servername }} {{ vhost.serveralias }};
{% else %}
    server_name {{ vhost.servername }};
{% endif %}

    access_log      /var/log/nginx/{{ vhost.servername }}_access.log;
    error_log       /var/log/nginx/{{ vhost.servername }}_error.log warn;

    location / {

{% if vhost.docroot is defined %}
    root {{ vhost.docroot }};
{% endif %}

{% if vhost.extra_parameters is defined %}
    {{ vhost.extra_parameters }}
{% endif %}

{% if vhost.proxy %}
    proxy_set_header          Host $host;
    proxy_set_header          Accept-Encoding "";
    proxy_set_header          X-Real-IP $remote_addr;
    proxy_set_header          X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header          X-Forwarded-Proto $scheme;
    proxy_buffering on;
    proxy_pass                http://{{ vhost.proxy.ip }}:{{ vhost.proxy.port }};
    proxy_read_timeout        90;
    proxy_redirect            http://{{ vhost.proxy.ip}}:{{ vhost.proxy.port }} http://$server_name;
{% endif %}

    }
}
{% endfor %}