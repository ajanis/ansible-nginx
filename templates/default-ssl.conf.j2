# {{ ansible_managed }}

{% for vhost in nginx_vhosts_ssl %}
server {
    listen {{ vhost.serverlisten }} ssl http2;
{% if vhost.serveralias is defined %}
    server_name {{ vhost.servername }} {{ vhost.serveralias }};
{% else %}
    server_name {{ vhost.servername }};
{% endif %}

    ssl_certificate           {{ vhost.sslcertfile }};
    ssl_certificate_key       {{ vhost.sslkeyfile }};
    
    include /etc/nginx/ssl.conf;
    
    access_log      /var/log/nginx/{{ vhost.servername }}_ssl_access.log;
    error_log       /var/log/nginx/{{ vhost.servername }}_ssl_error.log warn;

    location / {

{% if vhost.docroot is defined %}
    root {{ vhost.docroot }};
{% endif %}

{% if vhost.extra_parameters is defined %}
    {{ vhost.extra_parameters }}
{% endif %}

{% if vhost.proxy is defined and vhost.proxy %}
    include /etc/nginx/proxy.conf;
    proxy_pass                http://{{ vhost.proxy_ip }}:{{ vhost.proxy_port }};
    proxy_redirect            http://{{ vhost.proxy_ip}}:{{ vhost.proxy_port }} https://$server_name;
{% if vhost.custom_css is defined %}
    proxy_set_header Accept-Encoding "";
    sub_filter
    '</head>'
    '<link rel="stylesheet" type="text/css" href="https://gilbn.github.io/theme.park/CSS/themes/{{ vhost.custom_css }}">
    </head>';
    sub_filter_once on;
{% endif %}
{% endif %}

    }
}
{% endfor %}